Redis-Cluster搭建过程

1. 集群规划

服务器: Linux121、Linux122、Linux123
端口：7001，7002，7003，7004，7005，7006，7007，7008

Linux121: 7001, 7002, 7007, 7008
Linux122: 7003, 7004
Linux123: 7005, 7006

说明: 每个端口运行一个实例，其中Linux121服务器资源充足，运行4个实例


2. 修改redis.conf配置文件

(1)注释bind地址
# bind 127.0.0.1

(2) 关闭保护模式
protected-mode no

(3) 设置端口
port 7001

(4) 开启后台运行
daemonize yes

(5) 开启集群
cluster-enabled yes

说明: 将配置文件分发给每个Redis实例，并修改端口号


3. 启动集群并查看集群状态

(1) 启动集群
[root@linux121 bin]# ./redis-cli --cluster create 172.16.97.71:7001 172.16.97.71:7002 172.16.97.72:7003 172.16.97.72:7004 172.16.97.73:7005 172.16.97.73:7006 --cluster-replicas 1

(2) 查看集群状态
127.0.0.1:7005 > cluster nodes
d8dabbb077e61e5b9b3d3fd9c3993bcee14422b5 172.16.97.71:7002@17002 slave 9de3f8744ce2ff2127799ca6d50374bd9c5ad970 0 1606744371000 5 connected
9fe8ab4c972cd49211870dad1747cb32a2a0e576 172.16.97.71:7001@17001 master - 0 1606744370117 1 connected 0-5460
7e43141e545ebc7dcba21cd0e0398491d9621d52 172.16.97.72:7003@17003 master - 0 1606744369000 3 connected 5461-10922
9de3f8744ce2ff2127799ca6d50374bd9c5ad970 172.16.97.73:7005@17005 myself,master - 0 1606744369000 5 connected 10923-16383
8616ebdac80800910e5e8bdd45c7476b42730919 172.16.97.73:7006@17006 slave 7e43141e545ebc7dcba21cd0e0398491d9621d52 0 1606744368112 6 connected
68de7af82d2c4ee231257e1e1860ec962554dc33 172.16.97.72:7004@17004 slave 9fe8ab4c972cd49211870dad1747cb32a2a0e576 0 1606744371119 4 connected


4. 添加新的主节点和从节点

(1) 添加新的主节点
./redis-cli --cluster add-node 172.16.97.71:7007 172.16.97.71:7001 
(2) 分配hash槽
./redis-cli --cluster reshard 127.0.0.1:7007

说明: 选择分配给7007节点3000个槽位，选择模式是all，从原来的三个主节点平均取出1000个槽位给7007，分配完成后结果
9de3f8744ce2ff2127799ca6d50374bd9c5ad970 172.16.97.73:7005@17005 master - 0 1606745526197 5 connected 11922-16383
9fe8ab4c972cd49211870dad1747cb32a2a0e576 172.16.97.71:7001@17001 myself,master - 0 1606745522000 1 connected 999-5460
d8dabbb077e61e5b9b3d3fd9c3993bcee14422b5 172.16.97.71:7002@17002 slave 9de3f8744ce2ff2127799ca6d50374bd9c5ad970 0 1606745524000 5 connected
68de7af82d2c4ee231257e1e1860ec962554dc33 172.16.97.72:7004@17004 slave 9fe8ab4c972cd49211870dad1747cb32a2a0e576 0 1606745525000 4 connected
f8e5f1221c4c543c4376bba8015c6fc9adb652e7 172.16.97.71:7007@17007 master - 0 1606745523191 7 connected 0-998 5461-6461 10923-11921
8616ebdac80800910e5e8bdd45c7476b42730919 172.16.97.73:7006@17006 slave 7e43141e545ebc7dcba21cd0e0398491d9621d52 0 1606745525000 6 connected
7e43141e545ebc7dcba21cd0e0398491d9621d52 172.16.97.72:7003@17003 master - 0 1606745525195 3 connected 6462-10922

(3) 添加新的从节点
./redis-cli --cluster add-node 172.16.97.71:7008 172.16.97.71:7007 -- cluster-slave --cluster-master-id f8e5f1221c4c543c4376bba8015c6fc9adb652e7